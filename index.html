<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agenda — data.json</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a"/>
  <style>
    .right-edge { position: fixed; right: 0; top: 0; height: 100dvh; width: 2.5rem; opacity: 0; }
    @media (min-width: 768px) { .right-edge { width: 3rem; } }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-[100dvh]">
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span id="metaTitle" class="font-semibold">Agenda de classe</span>
        <span id="metaSchool" class="text-xs text-slate-500"></span>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <button id="btnToday" class="px-3 py-1.5 rounded-md border bg-white hover:bg-slate-50">Aujourd'hui</button>
        <button id="btnPrev" class="px-3 py-1.5 rounded-md border bg-white hover:bg-slate-50">&larr; Pr&eacute;c.</button>
        <button id="btnNext" class="px-3 py-1.5 rounded-md border bg-white hover:bg-slate-50">Suiv. &rarr;</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pt-5 pb-24">
    <div class="flex items-baseline justify-between mb-4">
      <h1 id="dayTitle" class="text-3xl font-bold tracking-tight">Aujourd'hui</h1>
      <div id="weekBadge" class="text-sm text-slate-600"></div>
    </div>

    <div id="cards" class="space-y-3"></div>

    <p class="mt-6 text-xs text-slate-500">
      Astuce : fl&egrave;ches &larr; / &rarr;, touche <kbd class="px-1 rounded border">T</kbd>, balayage gauche/droite sur mobile,
      ou clic sur le <em>bord droit</em> pour le lendemain.
    </p>
  </main>

  <button id="edgeNext" class="right-edge" aria-label="Jour suivant"></button>

<script>
// ---------- Constantes ----------
var WEEKDAYS_LONG = ["Samedi","Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi"];
var MONTHS = ["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"];

function startOfDay(d){ var x=new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d,n){ var x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtDayHeader(d){ return WEEKDAYS_LONG[d.getDay()] + " " + d.getDate() + " " + MONTHS[d.getMonth()]; }
function fmtTime(dt){ return dt.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",hour12:false}); }

// "8h-12h15" / "8h30-12h15" / "9h-13h"
function parseFRTimeRange(s){
  if(!s) return null;
  var norm = s.replace(/\s/g,"").replace("–","-").replace("—","-");
  var m = norm.match(/^(\d{1,2})(?:h|:)?(\d{0,2})?-(\d{1,2})(?:h|:)?(\d{0,2})?$/i);
  if(!m) return null;
  var h1 = parseInt(m[1],10);
  var m1 = m[2] ? parseInt(m[2],10) : 0;
  var h2 = parseInt(m[3],10);
  var m2 = m[4] ? parseInt(m[4],10) : 0;
  return {h1:h1,m1:m1,h2:h2,m2:m2};
}

// Construit les events depuis data.json
function buildEventsFromData(data){
  var events = [];
  var profMap = data.professeurs || {};
  var semaines = data.semaines || {};
  var planning = data.planning || {};

  var dayOffset = { "lundi":0, "mardi":1, "mercredi":2, "jeudi":3, "vendredi":4, "samedi":5, "dimanche":6 };

  function fullTeacher(code){
    if(!code) return "";
    if(code.toLowerCase() === "multiple") return "Intervenants multiples";
    var parts = code.split(/[+,/]/).map(function(s){ return s.trim(); }).filter(function(s){ return !!s; });
    var names = parts.map(function(p){ return profMap[p] || p; });
    return names.join(", ");
  }

  Object.keys(planning).forEach(function(w){
    var weekPlan = planning[w];
    var weekInfo = semaines[w];
    if(!weekInfo || !weekInfo.startDate) return;
    var startISO = weekInfo.startDate; // YYYY-MM-DD (lundi)
    var startDate = new Date(startISO + "T00:00:00");

    Object.keys(weekPlan).forEach(function(dayName){
      var jour = weekPlan[dayName];
      if(!jour) return;
      var offset = dayOffset[dayName];
      if(offset == null) return;
      var dayDate = addDays(startDate, offset);

      ["matin","aprem"].forEach(function(slot){
        var s = jour[slot];
        if(!s) return;
        if(!s.cours || !s.heure) return;
        var rng = parseFRTimeRange(s.heure);
        if(!rng) return;
        var start = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), rng.h1, rng.m1, 0);
        var end   = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), rng.h2, rng.m2, 0);

        events.push({
          title: s.cours,
          start: start,
          end: end,
          room: (s.salle||"").trim(),
          teacher: fullTeacher((s.prof||"").trim()),
          week: w,
          dayKey: dayName
        });
      });
    });
  });

  events.sort(function(a,b){ return +a.start - +b.start; });
  return events;
}

function groupByDay(events){
  var m = new Map();
  events.forEach(function(e){
    var key = e.start.toISOString().slice(0,10);
    if(!m.has(key)) m.set(key, []);
    m.get(key).push(e);
  });
  m.forEach(function(arr){ arr.sort(function(a,b){ return +a.start - +b.start; }); });
  return m;
}

function courseCard(e){
  var ongoing = (new Date() >= e.start && new Date() <= e.end);
  var badge = ongoing ? '<span class="ml-2 px-2 py-0.5 text-[10px] rounded-full bg-blue-100 text-blue-700">En cours</span>' : '';
  var room = e.room ? '<span class="inline-flex items-center gap-1 text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-8-4.438-8-10a8 8 0 1 1 16 0c0 5.562-8 10-8 10Z"></path><circle cx="12" cy="11" r="3"></circle></svg>' + e.room + '</span>' : '';
  var teacher = e.teacher ? '<span class="inline-flex items-center gap-1 text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>' + e.teacher + '</span>' : '';
  var color = "#0ea5e9";
  return '' +
  '<div class="rounded-2xl border bg-white shadow-sm p-4">' +
    '<div class="flex gap-3 items-start">' +
      '<span class="inline-block h-3 w-3 rounded-full ring-2 ring-white/70 mt-1" style="background:'+color+'"></span>' +
      '<div class="min-w-0 flex-1">' +
        '<div class="text-xs text-slate-500 flex items-center gap-2">' +
          '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>' +
          '<span>' + fmtTime(e.start) + ' - ' + fmtTime(e.end) + '</span>' +
          badge +
        '</div>' +
        '<h3 class="text-base font-semibold leading-tight mt-1">' + e.title + '</h3>' +
        '<div class="mt-1 text-sm flex flex-wrap gap-x-4 gap-y-1">' + room + teacher + '</div>' +
      '</div>' +
    '</div>' +
  '</div>';
}

var ALL_EVENTS = [];
var CURRENT_DATE = startOfDay(new Date());
var GROUPED = new Map();
var META = {};

function renderDay(){
  var cards = document.getElementById("cards");
  var dayTitle = document.getElementById("dayTitle");
  var weekBadge = document.getElementById("weekBadge");

  dayTitle.textContent = fmtDayHeader(CURRENT_DATE);
  var key = CURRENT_DATE.toISOString().slice(0,10);
  var list = GROUPED.get(key) || [];

  cards.innerHTML = "";
  if(list.length === 0){
    cards.innerHTML = '<div class="rounded-2xl border border-dashed p-6 text-center text-slate-500 bg-white">Pas de cours ce jour.</div>';
  } else {
    cards.innerHTML = list.map(courseCard).join("");
  }

  if(list.length){
    var w = list[0].week;
    var sem = (META.semaines && META.semaines[w]) ? META.semaines[w] : null;
    weekBadge.textContent = sem ? ("Semaine " + w + " - " + sem.dates) : "";
  } else {
    weekBadge.textContent = "";
  }
}

function nextDay(){ CURRENT_DATE = addDays(CURRENT_DATE, 1); renderDay(); }
function prevDay(){ CURRENT_DATE = addDays(CURRENT_DATE, -1); renderDay(); }
function goToday(){ CURRENT_DATE = startOfDay(new Date()); renderDay(); }

document.getElementById("btnNext").onclick = nextDay;
document.getElementById("btnPrev").onclick = prevDay;
document.getElementById("btnToday").onclick = goToday;
document.getElementById("edgeNext").onclick = nextDay;

window.addEventListener("keydown", function(e){
  if(e.key === "ArrowRight") nextDay();
  if(e.key === "ArrowLeft") prevDay();
  if((e.key||"").toLowerCase() === "t") goToday();
});

// Swipe
var tStart = null;
window.addEventListener("touchstart", function(e){ var t=e.changedTouches[0]; tStart={x:t.clientX,y:t.clientY}; });
window.addEventListener("touchend", function(e){
  if(!tStart) return;
  var t=e.changedTouches[0]; var dx=t.clientX - tStart.x; var dy=t.clientY - tStart.y;
  if(Math.abs(dx)>40 && Math.abs(dy)<50){ if(dx<0) nextDay(); else prevDay(); }
  tStart = null;
});

async function init(){
  var res = await fetch("data.json", {cache:"no-store"});
  var data = await res.json();
  META = data;
  document.getElementById("metaTitle").textContent = (data.meta && data.meta.title) ? data.meta.title : "Agenda de classe";
  document.getElementById("metaSchool").textContent = (data.meta && data.meta.school) ? (" — " + data.meta.school) : "";

  var events = buildEventsFromData(data);
  ALL_EVENTS = events;
  GROUPED = groupByDay(events);

  // On force à afficher la date du jour J (même si pas prévue dans le JSON)
    var todayKey = CURRENT_DATE.toISOString().slice(0,10);
    if(GROUPED.has(todayKey)){
    // il y a des cours aujourd'hui
    renderDay();
    } else {
    // pas de cours aujourd'hui mais on reste sur la vraie date du jour
    renderDay();
    }
}

init();
</script>
</body>
</html>